<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø´Ø¨ÙƒØ© Ø°ÙƒØ±ÙŠØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 600px;
    margin: 20px auto;
    padding: 10px;
    direction: rtl;
    background: #fafafa;
  }
  h2, h3 {
    text-align: center;
    color: #333;
  }
  input, textarea, select, button {
    width: 100%;
    padding: 8px;
    margin: 6px 0;
    font-size: 1rem;
    box-sizing: border-box;
  }
  button {
    background-color: #007bff;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 4px;
  }
  button:hover {
    background-color: #0056b3;
  }
  .hidden {
    display: none;
  }
  .message {
    padding: 8px;
    border-radius: 4px;
    margin-top: 10px;
    text-align: center;
  }
  .error {
    background: #fdd;
    color: #900;
  }
  .success {
    background: #dfd;
    color: #090;
  }
  .memory {
    background: white;
    padding: 10px;
    margin: 10px 0;
    border-radius: 6px;
    box-shadow: 0 1px 3px #ccc;
  }
  .memory .status {
    font-weight: bold;
    margin-bottom: 5px;
  }
  .memory .text {
    margin-bottom: 10px;
  }
  .memory .actions button {
    background: #eee;
    color: #555;
    border-radius: 3px;
    margin-right: 6px;
    width: auto;
    padding: 5px 10px;
  }
  .memory .actions button.liked {
    color: #e0245e;
    font-weight: bold;
  }
  #chat-box {
    border: 1px solid #ccc;
    background: white;
    height: 250px;
    overflow-y: auto;
    padding: 8px;
    border-radius: 6px;
  }
  #chat-input {
    display: flex;
    margin-top: 6px;
  }
  #chat-input input {
    flex: 1;
    margin: 0;
    padding: 8px;
  }
  #chat-input button {
    width: 80px;
    margin: 0 0 0 8px;
  }
</style>
</head>
<body>

<h2>Ø´Ø¨ÙƒØ© Ø°ÙƒØ±ÙŠØ§Øª Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ© Ù…ØªÙƒØ§Ù…Ù„Ø©</h2>

<!-- Ù‚Ø³Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="auth-section">
  <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
  <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
  <button id="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <button id="signup-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
  <div id="auth-message" class="message hidden"></div>
</div>

<!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="user-section" class="hidden">
  <h3>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="user-email"></span></h3>
  <button id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  
  <!-- Ù†Ø´Ø± Ø°ÙƒØ±Ù‰ -->
  <h3>Ù†Ø´Ø± Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©</h3>
  <textarea id="memory-text" placeholder="Ø§ÙƒØªØ¨ Ø°ÙƒØ±ÙŠØªÙƒ Ù‡Ù†Ø§..." rows="3"></textarea>
  <select id="memory-status">
    <option value="Ø³Ø¹ÙŠØ¯">Ø³Ø¹ÙŠØ¯ ğŸ˜Š</option>
    <option value="ÙØ±Ø­">ÙØ±Ø­ ğŸ‰</option>
    <option value="Ù…Ø­Ø¨Ø©">Ù…Ø­Ø¨Ø© â¤ï¸</option>
    <option value="Ø­Ø²Ù†">Ø­Ø²Ù† ğŸ˜¢</option>
    <option value="ØºØ¶Ø¨">ØºØ¶Ø¨ ğŸ˜ </option>
  </select>
  <button id="post-memory-btn">Ù†Ø´Ø± Ø§Ù„Ø°ÙƒØ±Ù‰</button>
  <div id="memory-message" class="message hidden"></div>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª -->
  <h3>Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</h3>
  <div id="memories-list"></div>

  <!-- Ø¯Ø±Ø¯Ø´Ø© -->
  <h3>Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</h3>
  <div id="chat-box"></div>
  <div id="chat-input">
    <input type="text" id="chat-message" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <button id="send-chat-btn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase (ØªØ£ÙƒØ¯ ØªØºÙŠØ± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù€ Ø­Ø³Ø§Ø¨Ùƒ)
  const firebaseConfig = {
    apiKey: "AIzaSyCKKkHfKFfwlgnEju0sk0s46t3DnG0bhtE",
    authDomain: "social-memories-89ec5.firebaseapp.com",
    projectId: "social-memories-89ec5",
    storageBucket: "social-memories-89ec5.appspot.com",
    messagingSenderId: "227392608508",
    appId: "1:227392608508:web:450fc4d2dece0329f39f79",
    measurementId: "G-6BRPV713MR"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();
  const realtimeDB = firebase.database();

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const authSection = document.getElementById("auth-section");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const loginBtn = document.getElementById("login-btn");
  const signupBtn = document.getElementById("signup-btn");
  const authMessage = document.getElementById("auth-message");

  const userSection = document.getElementById("user-section");
  const userEmailSpan = document.getElementById("user-email");
  const logoutBtn = document.getElementById("logout-btn");

  const memoryText = document.getElementById("memory-text");
  const memoryStatus = document.getElementById("memory-status");
  const postMemoryBtn = document.getElementById("post-memory-btn");
  const memoryMessage = document.getElementById("memory-message");
  const memoriesList = document.getElementById("memories-list");

  const chatBox = document.getElementById("chat-box");
  const chatMessageInput = document.getElementById("chat-message");
  const sendChatBtn = document.getElementById("send-chat-btn");

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  loginBtn.addEventListener("click", () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      showAuthMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(() => showAuthMessage("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "success"))
      .catch(e => showAuthMessage("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message, "error"));
  });

  // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
  signupBtn.addEventListener("click", () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      showAuthMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", "error");
      return;
    }
    auth.createUserWithEmailAndPassword(email, password)
      .then(() => showAuthMessage("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", "success"))
      .catch(e => showAuthMessage("ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + e.message, "error"));
  });

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  logoutBtn.addEventListener("click", () => {
    auth.signOut();
  });

  // Ù†Ø´Ø± Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©
  postMemoryBtn.addEventListener("click", () => {
    const text = memoryText.value.trim();
    const status = memoryStatus.value;

    if (!text) {
      showMemoryMessage("Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø°ÙƒØ±Ù‰", "error");
      return;
    }

    const user = auth.currentUser;
    if (!user) {
      showMemoryMessage("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ø°ÙƒØ±Ù‰", "error");
      return;
    }

    postMemoryBtn.disabled = true;

    db.collection("memories").add({
      uid: user.uid,
      email: user.email,
      text: text,
      status: status,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      likes: [],
      comments: []
    }).then(() => {
      memoryText.value = "";
      showMemoryMessage("ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø°ÙƒØ±Ù‰", "success");
      postMemoryBtn.disabled = false;
    }).catch(e => {
      showMemoryMessage("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø´Ø± Ø§Ù„Ø°ÙƒØ±Ù‰: " + e.message, "error");
      postMemoryBtn.disabled = false;
    });
  });

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª Ø¨Ø§Ø³ØªÙ…Ø±Ø§Ø±
  function loadMemories() {
    db.collection("memories")
      .orderBy("createdAt", "desc")
      .onSnapshot(snapshot => {
        memoriesList.innerHTML = "";
        snapshot.forEach(doc => {
          const memory = doc.data();
          const id = doc.id;
          renderMemory(id, memory);
        });
      });
  }

  // Ø±Ø³Ù… Ø°ÙƒØ±Ù‰ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
  function renderMemory(id, memory) {
    const user = auth.currentUser;
    const liked = memory.likes.includes(user?.uid);

    const div = document.createElement("div");
    div.className = "memory";

    div.innerHTML = `
      <div class="status">${memory.status}</div>
      <div class="text">${escapeHtml(memory.text)}</div>
      <div><small>Ù…Ù†: ${escapeHtml(memory.email)}</small></div>
      <div><small>ØªØ§Ø±ÙŠØ®: ${memory.createdAt ? memory.createdAt.toDate().toLocaleString() : "... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„"}</small></div>
      <div class="actions">
        <button class="like-btn ${liked ? 'liked' : ''}">${liked ? "â¤ï¸ ØªÙ… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨" : "â™¡ Ø¥Ø¹Ø¬Ø§Ø¨"} (${memory.likes.length})</button>
        <button class="comment-btn">ØªØ¹Ù„ÙŠÙ‚ (${memory.comments.length})</button>
      </div>
      <div class="comments-section hidden"></div>
    `;

    // Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
    const likeBtn = div.querySelector(".like-btn");
    likeBtn.onclick = () => {
      if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨");
        return;
      }
      const likes = memory.likes;
      const uidIndex = likes.indexOf(user.uid);
      if (uidIndex >= 0) likes.splice(uidIndex, 1);
      else likes.push(user.uid);

      db.collection("memories").doc(id).update({ likes });
    };

    // Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    const commentBtn = div.querySelector(".comment-btn");
    const commentsSection = div.querySelector(".comments-section");
    commentBtn.onclick = () => {
      if (!user) {
        alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚");
        return;
      }
      if (commentsSection.classList.contains("hidden")) {
        commentsSection.classList.remove("hidden");
        renderComments(id, memory.comments, commentsSection);
      } else {
        commentsSection.classList.add("hidden");
      }
    };

    memoriesList.appendChild(div);
  }

  // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
  function renderComments(memoryId, comments, container) {
    container.innerHTML = "";

    const list = document.createElement("div");
    comments.forEach(c => {
      const cDiv = document.createElement("div");
      cDiv.style.borderTop = "1px solid #ddd";
      cDiv.style.padding = "4px 0";
      cDiv.textContent = `${c.email}: ${c.text}`;
      list.appendChild(cDiv);
    });
    container.appendChild(list);

    // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§...";
    container.appendChild(input);

    const sendBtn = document.createElement("button");
    sendBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„";
    container.appendChild(sendBtn);

    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return alert("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ù‹Ø§");
      const user = auth.currentUser;
      if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");

      // Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø°Ø§ÙƒØ±Ø©
      const newComment = {
        email: user.email,
        text,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø³ØªÙˆØ±
      db.collection("memories").doc(memoryId).update({
        comments: firebase.firestore.FieldValue.arrayUnion(newComment)
      }).then(() => {
        input.value = "";
      }).catch(e => alert("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚: " + e.message));
    };
  }

  // ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© realtime
  function loadChat() {
    realtimeDB.ref("chat/messages").on("value", snapshot => {
      chatBox.innerHTML = "";
      const messages = snapshot.val();
      if (!messages) return;

      Object.values(messages).forEach(m => {
        const msgDiv = document.createElement("div");
        msgDiv.textContent = `${m.email}: ${m.text}`;
        msgDiv.style.borderBottom = "1px solid #eee";
        msgDiv.style.padding = "4px 0";
        chatBox.appendChild(msgDiv);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¯Ø±Ø¯Ø´Ø©
  sendChatBtn.addEventListener("click", () => {
    const text = chatMessageInput.value.trim();
    const user = auth.currentUser;
    if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©");
    if (!text) return;

    const msg = {
      uid: user.uid,
      email: user.email,
      text,
      timestamp: Date.now()
    };

    realtimeDB.ref("chat/messages").push(msg);
    chatMessageInput.value = "";
  });

  // ØªÙ‡ÙŠØ¦Ø© ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  auth.onAuthStateChanged(user => {
    if (user) {
      authSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      userEmailSpan.textContent = user.email;

      loadMemories();
      loadChat();
    } else {
      authSection.classList.remove("hidden");
      userSection.classList.add("hidden");
      userEmailSpan.textContent = "";
      memoriesList.innerHTML = "";
      chatBox.innerHTML = "";
    }
  });

  // Ø±Ø³Ø§Ø¦Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  function showAuthMessage(msg, type) {
    authMessage.textContent = msg;
    authMessage.className = "message " + (type === "error" ? "error" : "success");
    authMessage.classList.remove("hidden");
  }
  function showMemoryMessage(msg, type) {
    memoryMessage.textContent = msg;
    memoryMessage.className = "message " + (type === "error" ? "error" : "success");
    memoryMessage.classList.remove("hidden");
    setTimeout(() => memoryMessage.classList.add("hidden"), 3000);
  }

  // Ø¯Ø§Ù„Ø© Ù‡Ø±ÙˆØ¨ HTML Ù„Ù…Ù†Ø¹ XSS
  function escapeHtml(text) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
