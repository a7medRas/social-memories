<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø¬Ø¯Ø§Ø± Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script type="module">
    // Firebase config
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, increment, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    // --- ØªØ·Ø¨ÙŠÙ‚ Ø¬Ø¯Ø§Ø± Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª ---

    const container = document.getElementById("app");

    const loadUsers = async () => {
      const snap = await getDocs(collection(db, "users"));
      const users = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      container.innerHTML = `
        <h2 class="text-xl font-bold mb-2">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
        <input id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…..." class="border p-2 mb-4 rounded w-full"/>
        <ul id="usersList" class="space-y-2"></ul>
      `;

      const searchInput = document.getElementById("searchInput");
      const usersList = document.getElementById("usersList");

      const renderList = (filter = "") => {
        const filtered = users.filter(u => u.displayName?.toLowerCase().includes(filter.toLowerCase()));
        usersList.innerHTML = filtered.length === 0
          ? "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†.</p>"
          : filtered.map(user =>
              `<li><button onclick="loadProfile('${user.id}')" class="text-blue-600 underline">ğŸ‘¤ ${user.displayName}</button></li>`
            ).join("");
      };

      renderList();
      searchInput.addEventListener("input", e => renderList(e.target.value));
    };

    window.loadProfile = async (uid) => {
      container.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ...</p>";
      const userSnap = await getDoc(doc(db, "users", uid));
      const user = userSnap.data();
      if (!user) return container.innerHTML = "<p>âŒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>";

      const memSnap = await getDocs(collection(db, `users/${uid}/memories`));
      const memories = memSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const commentsMap = {};
      for (const memory of memories) {
        const commSnap = await getDocs(
          query(collection(db, `users/${uid}/memories/${memory.id}/comments`), orderBy("timestamp", "desc"))
        );
        commentsMap[memory.id] = commSnap.docs.map(doc => doc.data());
      }

      const memHtml = memories.map(m => `
        <li class="mb-4 border-b pb-2">
          <div>${m.title || "Ø°ÙƒØ±Ù‰ Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†"}</div>
          <button onclick="like('${uid}', '${m.id}')" class="text-blue-600">ğŸ‘ ${m.likes || 0} Ø¥Ø¹Ø¬Ø§Ø¨</button>
          <button onclick="comment('${uid}', '${m.id}')" class="text-green-600 ml-4">ğŸ’¬ ${m.commentsCount || 0} ØªØ¹Ù„ÙŠÙ‚</button>
          <ul class="text-sm mt-2">
            ${(commentsMap[m.id] || []).map(c =>
              `<li><strong>${c.displayName}:</strong> ${c.text}</li>`
            ).join("")}
          </ul>
        </li>
      `).join("");

      container.innerHTML = `
        <div class="mb-4">
          <h2 class="text-xl font-bold">ğŸ‘¤ ${user.displayName}</h2>
          <p><strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> ${user.email}</p>
        </div>
        <div class="mb-4">
          <button onclick="loadUsers()" class="text-blue-600">ğŸ”™ Ø¹ÙˆØ¯Ø©</button>
        </div>
        <ul>${memHtml || "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°ÙƒØ±ÙŠØ§Øª</p>"}</ul>
      `;
    };

    window.like = async (uid, mid) => {
      const ref = doc(db, `users/${uid}/memories/${mid}`);
      await updateDoc(ref, { likes: increment(1) });
      loadProfile(uid);
    };

    window.comment = async (uid, mid) => {
      const text = prompt("Ø£Ø¯Ø®Ù„ ØªØ¹Ù„ÙŠÙ‚Ùƒ:");
      if (!text) return;
      const user = auth.currentUser || { displayName: "Ù…Ø¬Ù‡ÙˆÙ„" };
      const comment = {
        text,
        timestamp: new Date(),
        displayName: user.displayName || "Ù…Ø¬Ù‡ÙˆÙ„",
      };
      await addDoc(collection(db, `users/${uid}/memories/${mid}/comments`), comment);
      await updateDoc(doc(db, `users/${uid}/memories/${mid}`), {
        commentsCount: increment(1)
      });
      loadProfile(uid);
    };

    onAuthStateChanged(auth, () => {
      loadUsers();
    });
  </script>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white font-sans">
  <div id="app" class="p-6 max-w-xl mx-auto text-right"></div>
</body>
</html>
