<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Memories</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; }
  header { background:#2c3e50; color:#fff; padding:10px 15px; display:flex; justify-content: space-between; align-items: center; }
  header h1 { margin:0; font-size:1.4em; }
  #user-info { font-size: 0.9em; }
  #main { padding:15px; max-width:700px; margin: auto; }
  .hidden { display:none !important; }
  button { cursor:pointer; }
  input, textarea, select { width:100%; padding:8px; margin:5px 0 10px 0; border:1px solid #ccc; border-radius:4px; }
  textarea { resize: vertical; }
  #login-section, #register-section, #user-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  #memories-list > div.memory { background:#fff; padding:12px; margin-bottom:15px; border-radius:8px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
  #memories-list div.memory img { max-width: 100%; border-radius: 6px; margin-top: 6px; }
  .actions button { margin-right:10px; background:#eee; border:none; border-radius:4px; padding:6px 12px; }
  .actions button.liked { color:red; font-weight:bold; }
  .status { font-weight: bold; margin-bottom: 6px; }
  #camera-container video { border-radius: 6px; }
  #chat-section { position: fixed; bottom: 10px; left: 10px; width: 320px; max-height: 400px; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.2); border-radius: 10px; display: flex; flex-direction: column; }
  #chat-header { background:#3498db; color:#fff; padding: 10px; border-radius: 10px 10px 0 0; font-weight: bold; }
  #chat-messages { flex:1; overflow-y: auto; padding: 10px; }
  #chat-input { display:flex; padding: 10px; border-top:1px solid #ccc; }
  #chat-input input { flex:1; padding: 8px; border-radius: 4px; border:1px solid #ccc; }
  #chat-input button { margin-right: 6px; background:#3498db; color:#fff; border:none; padding: 8px 12px; border-radius: 4px; }
  #nav-icons { position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 8px 12px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); display: flex; gap: 15px; font-size: 1.6em; cursor: pointer; }
  #search-section { background:#fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  #search-results { margin-top: 10px; max-height: 200px; overflow-y: auto; }
  #search-results div { padding: 8px; border-bottom: 1px solid #eee; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

</head>
<body>

<header>
  <h1>Social Memories</h1>
  <div id="user-info">لم يتم تسجيل الدخول</div>
</header>

<div id="main">

  <!-- تسجيل الدخول -->
  <section id="login-section">
    <h2>تسجيل الدخول</h2>
    <input type="email" id="login-email" placeholder="البريد الإلكتروني" />
    <input type="password" id="login-password" placeholder="كلمة المرور" />
    <button id="login-btn">دخول</button>
    <p>لا تملك حسابًا؟ <a href="#" id="show-register">إنشاء حساب جديد</a></p>
    <div id="login-msg"></div>
  </section>

  <!-- تسجيل حساب جديد -->
  <section id="register-section" class="hidden">
    <h2>إنشاء حساب جديد</h2>
    <input type="email" id="register-email" placeholder="البريد الإلكتروني" />
    <input type="password" id="register-password" placeholder="كلمة المرور" />
    <button id="register-btn">إنشاء حساب</button>
    <p>هل لديك حساب؟ <a href="#" id="show-login">تسجيل الدخول</a></p>
    <div id="register-msg"></div>
  </section>

  <!-- قسم المستخدم بعد تسجيل الدخول -->
  <section id="user-section" class="hidden">
    <h2>نشر ذكرى جديدة</h2>

    <select id="memory-status">
      <option value="سعيد">سعيد 😊</option>
      <option value="فرح">فرح 😄</option>
      <option value="محبة">محبة ❤️</option>
      <option value="حزين">حزين 😢</option>
      <option value="متفائل">متفائل 🌟</option>
    </select>

    <textarea id="memory-text" rows="4" placeholder="اكتب ذكرياتك هنا..."></textarea>

    <button id="open-camera-btn">فتح الكاميرا</button>
    <div id="camera-container" class="hidden" style="margin-top:10px;">
      <video id="video" width="100%" autoplay playsinline></video>
      <button id="capture-btn" style="margin-top:6px;">التقاط صورة</button>
      <button id="close-camera-btn" style="margin-top:6px; background:#d33; color:#fff;">إغلاق الكاميرا</button>
    </div>
    <img id="captured-image" class="hidden" alt="صورة الذكرى" style="margin-top:10px; width:100%; border-radius:6px; border:1px solid #aaa;" />

    <button id="post-memory-btn" style="margin-top:15px;">نشر الذكرى</button>
    <button id="logout-btn" style="margin-top:15px; background:#e74c3c; color:#fff;">تسجيل خروج</button>
    <div id="memory-msg"></div>
  </section>

  <!-- قسم عرض الذكريات -->
  <section id="memories-section" class="hidden">
    <h2>الذكريات</h2>
    <div id="memories-list"></div>
  </section>

  <!-- قسم البحث عن المستخدمين -->
  <section id="search-section" class="hidden">
    <h2>البحث عن مستخدمين</h2>
    <input type="text" id="search-input" placeholder="ابحث باسم المستخدم..." />
    <div id="search-results"></div>
  </section>

</div>

<!-- الدردشة -->
<div id="chat-section" class="hidden">
  <div id="chat-header">💬 الدردشة
    <button id="close-chat-btn" style="float:left; background:#e74c3c; border:none; color:#fff; border-radius:4px; cursor:pointer;">×</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="chat-message-input" placeholder="اكتب رسالة..." />
    <button id="chat-send-btn">إرسال</button>
  </div>
</div>

<!-- أزرار التنقل -->
<div id="nav-icons">
  <span id="live-icon" title="البث المباشر" style="color:#e74c3c;">🔴</span>
  <span id="chat-icon" title="الدردشة">💬</span>
  <span id="search-icon" title="بحث المستخدمين">🔍</span>
</div>

<script>
  // --- تهيئة Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyCKKkHfKFfwlgnEju0sk0s46t3DnG0bhtE",
    authDomain: "social-memories-89ec5.firebaseapp.com",
    projectId: "social-memories-89ec5",
    storageBucket: "social-memories-89ec5.appspot.com",
    messagingSenderId: "227392608508",
    appId: "1:227392608508:web:450fc4d2dece0329f39f79",
    measurementId: "G-6BRPV713MR"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // --- عناصر DOM ---
  const loginSection = document.getElementById("login-section");
  const registerSection = document.getElementById("register-section");
  const userSection = document.getElementById("user-section");
  const memoriesSection = document.getElementById("memories-section");
  const searchSection = document.getElementById("search-section");
  const userInfo = document.getElementById("user-info");

  // تسجيل الدخول
  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");
  const loginBtn = document.getElementById("login-btn");
  const loginMsg = document.getElementById("login-msg");

  // تسجيل جديد
  const registerEmail = document.getElementById("register-email");
  const registerPassword = document.getElementById("register-password");
  const registerBtn = document.getElementById("register-btn");
  const registerMsg = document.getElementById("register-msg");

  // نشر ذكرى
  const memoryStatus = document.getElementById("memory-status");
  const memoryText = document.getElementById("memory-text");
  const postMemoryBtn = document.getElementById("post-memory-btn");
  const memoryMsg = document.getElementById("memory-msg");
  const logoutBtn = document.getElementById("logout-btn");

  // الكاميرا
  const openCameraBtn = document.getElementById("open-camera-btn");
  const cameraContainer = document.getElementById("camera-container");
  const video = document.getElementById("video");
  const captureBtn = document.getElementById("capture-btn");
  const closeCameraBtn = document.getElementById("close-camera-btn");
  const capturedImage = document.getElementById("captured-image");
  let stream;
  let capturedPhoto = null;

  // عرض الذكريات
  const memoriesList = document.getElementById("memories-list");

  // الدردشة
  const chatSection = document.getElementById("chat-section");
  const chatIcon = document.getElementById("chat-icon");
  const closeChatBtn = document.getElementById("close-chat-btn");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-message-input");
  const chatSendBtn = document.getElementById("chat-send-btn");

  // البث المباشر
  const liveIcon = document.getElementById("live-icon");

  // البحث
  const searchIcon = document.getElementById("search-icon");
  const searchInput = document.getElementById("search-input");
  const searchResults = document.getElementById("search-results");

  // --- التبديل بين الصفحات ---
  document.getElementById("show-register").onclick = e => {
    e.preventDefault();
    loginSection.classList.add("hidden");
    registerSection.classList.remove("hidden");
    memoryMsg.innerHTML = "";
    loginMsg.innerHTML = "";
  };

  document.getElementById("show-login").onclick = e => {
    e.preventDefault();
    registerSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
    memoryMsg.innerHTML = "";
    registerMsg.innerHTML = "";
  };

  // --- تسجيل دخول ---
  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
      .then(() => {
        loginMsg.textContent = "";
      })
      .catch(e => {
        loginMsg.textContent = "خطأ: " + e.message;
      });
  };

  // --- تسجيل جديد ---
  registerBtn.onclick = () => {
    registerMsg.textContent = "";
    auth.createUserWithEmailAndPassword(registerEmail.value, registerPassword.value)
      .then(() => {
        registerMsg.textContent = "";
      })
      .catch(e => {
        registerMsg.textContent = "خطأ: " + e.message;
      });
  };

  // --- تسجيل خروج ---
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // --- تتبع حالة تسجيل الدخول ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userInfo.textContent = `مرحباً، ${user.email}`;
      loginSection.classList.add("hidden");
      registerSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      memoriesSection.classList.remove("hidden");
      searchSection.classList.add("hidden");
      memoryMsg.textContent = "";
      loadMemories();
      loadSearchResults("");
    } else {
      userInfo.textContent = "لم يتم تسجيل الدخول";
      loginSection.classList.remove("hidden");
      registerSection.classList.add("hidden");
      userSection.classList.add("hidden");
      memoriesSection.classList.add("hidden");
      searchSection.classList.add("hidden");
      memoriesList.innerHTML = "";
    }
  });

  // --- فتح وإغلاق الكاميرا ---
  openCameraBtn.onclick = async () => {
    cameraContainer.classList.remove("hidden");
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (e) {
      alert("تعذر فتح الكاميرا: " + e.message);
    }
  };

  captureBtn.onclick = () => {
    if (!stream) return alert("الكاميرا غير مفعلة");
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    capturedPhoto = canvas.toDataURL("image/png");
    capturedImage.src = capturedPhoto;
    capturedImage.classList.remove("hidden");
    stopCamera();
    cameraContainer.classList.add("hidden");
  };

  closeCameraBtn.onclick = () => {
    stopCamera();
    cameraContainer.classList.add("hidden");
  };

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }

  // --- نشر ذكرى جديدة ---
  postMemoryBtn.onclick = () => {
    memoryMsg.textContent = "";
    const text = memoryText.value.trim();
    const status = memoryStatus.value;
    const user = auth.currentUser;

    if (!user) {
      memoryMsg.textContent = "يجب تسجيل الدخول لنشر ذكرى.";
      return;
    }
    if (!text) {
      memoryMsg.textContent = "الرجاء كتابة نص الذكرى.";
      return;
    }

    postMemoryBtn.disabled = true;

    db.collection("memories").add({
      uid: user.uid,
      email: user.email,
      text,
      status,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      likes: [],
      comments: [],
      image: capturedPhoto || null
    }).then(() => {
      memoryText.value = "";
      capturedPhoto = null;
      capturedImage.src = "";
      capturedImage.classList.add("hidden");
      memoryMsg.textContent = "تم نشر الذكرى بنجاح!";
      postMemoryBtn.disabled = false;
    }).catch(e => {
      memoryMsg.textContent = "حدث خطأ أثناء النشر: " + e.message;
      postMemoryBtn.disabled = false;
    });
  };

  // --- تحميل الذكريات ---
  function loadMemories() {
    memoriesList.innerHTML = "";
    db.collection("memories").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      memoriesList.innerHTML = "";
      snapshot.forEach(doc => {
        renderMemory(doc.id, doc.data());
      });
    });
  }

  // --- عرض ذكرى ---
  function renderMemory(id, memory) {
    const user = auth.currentUser;
    const liked = memory.likes.includes(user?.uid);

    const div = document.createElement("div");
    div.className = "memory";

    div.innerHTML = `
      <div class="status">${escapeHtml(memory.status)}</div>
      <div class="text">${escapeHtml(memory.text)}</div>
      ${memory.image ? `<img src="${memory.image}" alt="صورة الذكرى">` : ""}
      <div><small>من: ${escapeHtml(memory.email)}</small></div>
      <div><small>تاريخ: ${memory.createdAt ? memory.createdAt.toDate().toLocaleString() : "جاري التحميل..."}</small></div>
      <div class="actions">
        <button class="like-btn ${liked ? 'liked' : ''}">${liked ? "❤️ إلغاء إعجاب" : "🤍 إعجاب"} (${memory.likes.length})</button>
        <button class="comment-btn">💬 تعليق (${memory.comments.length})</button>
      </div>
      <div class="comments-list" style="margin-top:10px;"></div>
    `;

    const likeBtn = div.querySelector(".like-btn");
    const commentBtn = div.querySelector(".comment-btn");
    const commentsList = div.querySelector(".comments-list");

    // عرض التعليقات
    commentsList.innerHTML = "";
    memory.comments.forEach(comment => {
      const c = document.createElement("div");
      c.style.borderTop = "1px solid #eee";
      c.style.padding = "6px 0";
      c.innerHTML = `<b>${escapeHtml(comment.email)}</b>: ${escapeHtml(comment.text)}`;
      commentsList.appendChild(c);
    });

    // زر الإعجاب
    likeBtn.onclick = () => {
      if (!user) return alert("يجب تسجيل الدخول للإعجاب.");
      const userLiked = memory.likes.includes(user.uid);
      const updatedLikes = userLiked
        ? memory.likes.filter(uid => uid !== user.uid)
        : [...memory.likes, user.uid];

      db.collection("memories").doc(id).update({ likes: updatedLikes });
    };

    // زر التعليق
    commentBtn.onclick = () => {
      if (!user) return alert("يجب تسجيل الدخول للتعليق.");
      const commentText = prompt("اكتب تعليقك:");
      if (commentText && commentText.trim()) {
        const newComment = {
          email: user.email,
          text: commentText.trim(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection("memories").doc(id).update({
          comments: firebase.firestore.FieldValue.arrayUnion(newComment)
        });
      }
    };

    memoriesList.appendChild(div);
  }

  // --- هروب النصوص لمنع XSS ---
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // --- الدردشة ---
  chatIcon.onclick = () => {
    chatSection.classList.toggle("hidden");
    loadChatMessages();
  };
  closeChatBtn.onclick = () => {
    chatSection.classList.add("hidden");
  };

  // --- تحميل رسائل الدردشة ---
  let chatUnsub;
  function loadChatMessages() {
    if (chatUnsub) chatUnsub();
    chatMessages.innerHTML = "";
    chatUnsub = db.collection("chat")
      .orderBy("createdAt")
      .limitToLast(50)
      .onSnapshot(snapshot => {
        chatMessages.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.style.padding = "4px 0";
          div.innerHTML = `<b>${escapeHtml(msg.email)}</b>: ${escapeHtml(msg.text)}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
  }

  // --- إرسال رسالة الدردشة ---
  chatSendBtn.onclick = () => {
    const text = chatInput.value.trim();
    const user = auth.currentUser;
    if (!user) {
      alert("يجب تسجيل الدخول للدردشة.");
      return;
    }
    if (!text) return;

    db.collection("chat").add({
      uid: user.uid,
      email: user.email,
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatInput.value = "";
  };

  // --- زر البث المباشر ---
  liveIcon.onclick = () => {
    alert("الخاصية قيد الصيانة حالياً.");
  };

  // --- البحث عن المستخدمين ---
  searchIcon.onclick = () => {
    if (searchSection.classList.contains("hidden")) {
      searchSection.classList.remove("hidden");
      memoriesSection.classList.add("hidden");
      userSection.classList.add("hidden");
      loadSearchResults("");
    } else {
      searchSection.classList.add("hidden");
      memoriesSection.classList.remove("hidden");
      userSection.classList.remove("hidden");
    }
  };

  searchInput.oninput = () => {
    const query = searchInput.value.trim().toLowerCase();
    loadSearchResults(query);
  };

  function loadSearchResults(query) {
    searchResults.innerHTML = "جارٍ البحث...";
    db.collection("users")
      .get()
      .then(snapshot => {
        let users = [];
        snapshot.forEach(doc => {
          users.push(doc.data());
        });
        // فلترة المستخدمين حسب الاسم أو البريد (يمكن تعديل حسب احتياج)
        if (query) {
          users = users.filter(u => (u.email || "").toLowerCase().includes(query));
        }
        if (users.length === 0) {
          searchResults.innerHTML = "لا يوجد نتائج.";
          return;
        }
        searchResults.innerHTML = "";
        users.forEach(u => {
          const div = document.createElement("div");
          div.textContent = u.email;
          searchResults.appendChild(div);
        });
      }).catch(e => {
        searchResults.innerHTML = "حدث خطأ في البحث.";
      });
  }

  // --- تخزين المستخدمين عند التسجيل ---
  auth.onAuthStateChanged(user => {
    if (user) {
      // تأكد أن بيانات المستخدم موجودة في مجموعة users
      db.collection("users").doc(user.uid).set({
        email: user.email,
        uid: user.uid
      }, { merge: true });
    }
  });

</script>

</body>
</html>
