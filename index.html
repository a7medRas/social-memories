<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Social Memories</title>
<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0; }
  header { background:#2c3e50; color:#fff; padding:10px 15px; display:flex; justify-content: space-between; align-items: center; }
  header h1 { margin:0; font-size:1.4em; }
  #user-info { font-size: 0.9em; }
  #main { padding:15px; max-width:700px; margin: auto; }
  .hidden { display:none !important; }
  button { cursor:pointer; }
  input, textarea, select { width:100%; padding:8px; margin:5px 0 10px 0; border:1px solid #ccc; border-radius:4px; }
  textarea { resize: vertical; }
  #login-section, #register-section, #user-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  #memories-list > div.memory { background:#fff; padding:12px; margin-bottom:15px; border-radius:8px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
  #memories-list div.memory img { max-width: 100%; border-radius: 6px; margin-top: 6px; }
  .actions button { margin-right:10px; background:#eee; border:none; border-radius:4px; padding:6px 12px; }
  .actions button.liked { color:red; font-weight:bold; }
  .status { font-weight: bold; margin-bottom: 6px; }
  #camera-container video { border-radius: 6px; }
  #chat-section { position: fixed; bottom: 10px; left: 10px; width: 320px; max-height: 400px; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.2); border-radius: 10px; display: flex; flex-direction: column; }
  #chat-header { background:#3498db; color:#fff; padding: 10px; border-radius: 10px 10px 0 0; font-weight: bold; }
  #chat-messages { flex:1; overflow-y: auto; padding: 10px; }
  #chat-input { display:flex; padding: 10px; border-top:1px solid #ccc; }
  #chat-input input { flex:1; padding: 8px; border-radius: 4px; border:1px solid #ccc; }
  #chat-input button { margin-right: 6px; background:#3498db; color:#fff; border:none; padding: 8px 12px; border-radius: 4px; }
  #nav-icons { position: fixed; bottom: 10px; right: 10px; background: #fff; padding: 8px 12px; border-radius: 10px; box-shadow: 0 0 8px rgba(0,0,0,0.1); display: flex; gap: 15px; font-size: 1.6em; cursor: pointer; }
  #search-section { background:#fff; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow:0 0 6px rgba(0,0,0,0.1); }
  #search-results { margin-top: 10px; max-height: 200px; overflow-y: auto; }
  #search-results div { padding: 8px; border-bottom: 1px solid #eee; }
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

</head>
<body>

<header>
  <h1>Social Memories</h1>
  <div id="user-info">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</div>
</header>

<div id="main">

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="login-section">
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="login-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <input type="password" id="login-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="login-btn">Ø¯Ø®ÙˆÙ„</button>
    <p>Ù„Ø§ ØªÙ…Ù„Ùƒ Ø­Ø³Ø§Ø¨Ù‹Ø§ØŸ <a href="#" id="show-register">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a></p>
    <div id="login-msg"></div>
  </section>

  <!-- ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ -->
  <section id="register-section" class="hidden">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <input type="email" id="register-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <input type="password" id="register-password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="register-btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <p>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ <a href="#" id="show-login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a></p>
    <div id="register-msg"></div>
  </section>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <section id="user-section" class="hidden">
    <h2>Ù†Ø´Ø± Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø©</h2>

    <select id="memory-status">
      <option value="Ø³Ø¹ÙŠØ¯">Ø³Ø¹ÙŠØ¯ ğŸ˜Š</option>
      <option value="ÙØ±Ø­">ÙØ±Ø­ ğŸ˜„</option>
      <option value="Ù…Ø­Ø¨Ø©">Ù…Ø­Ø¨Ø© â¤ï¸</option>
      <option value="Ø­Ø²ÙŠÙ†">Ø­Ø²ÙŠÙ† ğŸ˜¢</option>
      <option value="Ù…ØªÙØ§Ø¦Ù„">Ù…ØªÙØ§Ø¦Ù„ ğŸŒŸ</option>
    </select>

    <textarea id="memory-text" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø°ÙƒØ±ÙŠØ§ØªÙƒ Ù‡Ù†Ø§..."></textarea>

    <button id="open-camera-btn">ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    <div id="camera-container" class="hidden" style="margin-top:10px;">
      <video id="video" width="100%" autoplay playsinline></video>
      <button id="capture-btn" style="margin-top:6px;">Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
      <button id="close-camera-btn" style="margin-top:6px; background:#d33; color:#fff;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
    </div>
    <img id="captured-image" class="hidden" alt="ØµÙˆØ±Ø© Ø§Ù„Ø°ÙƒØ±Ù‰" style="margin-top:10px; width:100%; border-radius:6px; border:1px solid #aaa;" />

    <button id="post-memory-btn" style="margin-top:15px;">Ù†Ø´Ø± Ø§Ù„Ø°ÙƒØ±Ù‰</button>
    <button id="logout-btn" style="margin-top:15px; background:#e74c3c; color:#fff;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    <div id="memory-msg"></div>
  </section>

  <!-- Ù‚Ø³Ù… Ø¹Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª -->
  <section id="memories-section" class="hidden">
    <h2>Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª</h2>
    <div id="memories-list"></div>
  </section>

  <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
  <section id="search-section" class="hidden">
    <h2>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
    <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…..." />
    <div id="search-results"></div>
  </section>

</div>

<!-- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chat-section" class="hidden">
  <div id="chat-header">ğŸ’¬ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
    <button id="close-chat-btn" style="float:left; background:#e74c3c; border:none; color:#fff; border-radius:4px; cursor:pointer;">Ã—</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input">
    <input type="text" id="chat-message-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." />
    <button id="chat-send-btn">Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ -->
<div id="nav-icons">
  <span id="live-icon" title="Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±" style="color:#e74c3c;">ğŸ”´</span>
  <span id="chat-icon" title="Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">ğŸ’¬</span>
  <span id="search-icon" title="Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†">ğŸ”</span>
</div>

<script>
  // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyCKKkHfKFfwlgnEju0sk0s46t3DnG0bhtE",
    authDomain: "social-memories-89ec5.firebaseapp.com",
    projectId: "social-memories-89ec5",
    storageBucket: "social-memories-89ec5.appspot.com",
    messagingSenderId: "227392608508",
    appId: "1:227392608508:web:450fc4d2dece0329f39f79",
    measurementId: "G-6BRPV713MR"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // --- Ø¹Ù†Ø§ØµØ± DOM ---
  const loginSection = document.getElementById("login-section");
  const registerSection = document.getElementById("register-section");
  const userSection = document.getElementById("user-section");
  const memoriesSection = document.getElementById("memories-section");
  const searchSection = document.getElementById("search-section");
  const userInfo = document.getElementById("user-info");

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const loginEmail = document.getElementById("login-email");
  const loginPassword = document.getElementById("login-password");
  const loginBtn = document.getElementById("login-btn");
  const loginMsg = document.getElementById("login-msg");

  // ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
  const registerEmail = document.getElementById("register-email");
  const registerPassword = document.getElementById("register-password");
  const registerBtn = document.getElementById("register-btn");
  const registerMsg = document.getElementById("register-msg");

  // Ù†Ø´Ø± Ø°ÙƒØ±Ù‰
  const memoryStatus = document.getElementById("memory-status");
  const memoryText = document.getElementById("memory-text");
  const postMemoryBtn = document.getElementById("post-memory-btn");
  const memoryMsg = document.getElementById("memory-msg");
  const logoutBtn = document.getElementById("logout-btn");

  // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  const openCameraBtn = document.getElementById("open-camera-btn");
  const cameraContainer = document.getElementById("camera-container");
  const video = document.getElementById("video");
  const captureBtn = document.getElementById("capture-btn");
  const closeCameraBtn = document.getElementById("close-camera-btn");
  const capturedImage = document.getElementById("captured-image");
  let stream;
  let capturedPhoto = null;

  // Ø¹Ø±Ø¶ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª
  const memoriesList = document.getElementById("memories-list");

  // Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
  const chatSection = document.getElementById("chat-section");
  const chatIcon = document.getElementById("chat-icon");
  const closeChatBtn = document.getElementById("close-chat-btn");
  const chatMessages = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-message-input");
  const chatSendBtn = document.getElementById("chat-send-btn");

  // Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
  const liveIcon = document.getElementById("live-icon");

  // Ø§Ù„Ø¨Ø­Ø«
  const searchIcon = document.getElementById("search-icon");
  const searchInput = document.getElementById("search-input");
  const searchResults = document.getElementById("search-results");

  // --- Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª ---
  document.getElementById("show-register").onclick = e => {
    e.preventDefault();
    loginSection.classList.add("hidden");
    registerSection.classList.remove("hidden");
    memoryMsg.innerHTML = "";
    loginMsg.innerHTML = "";
  };

  document.getElementById("show-login").onclick = e => {
    e.preventDefault();
    registerSection.classList.add("hidden");
    loginSection.classList.remove("hidden");
    memoryMsg.innerHTML = "";
    registerMsg.innerHTML = "";
  };

  // --- ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ ---
  loginBtn.onclick = () => {
    loginMsg.textContent = "";
    auth.signInWithEmailAndPassword(loginEmail.value, loginPassword.value)
      .then(() => {
        loginMsg.textContent = "";
      })
      .catch(e => {
        loginMsg.textContent = "Ø®Ø·Ø£: " + e.message;
      });
  };

  // --- ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ---
  registerBtn.onclick = () => {
    registerMsg.textContent = "";
    auth.createUserWithEmailAndPassword(registerEmail.value, registerPassword.value)
      .then(() => {
        registerMsg.textContent = "";
      })
      .catch(e => {
        registerMsg.textContent = "Ø®Ø·Ø£: " + e.message;
      });
  };

  // --- ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ---
  logoutBtn.onclick = () => {
    auth.signOut();
  };

  // --- ØªØªØ¨Ø¹ Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userInfo.textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${user.email}`;
      loginSection.classList.add("hidden");
      registerSection.classList.add("hidden");
      userSection.classList.remove("hidden");
      memoriesSection.classList.remove("hidden");
      searchSection.classList.add("hidden");
      memoryMsg.textContent = "";
      loadMemories();
      loadSearchResults("");
    } else {
      userInfo.textContent = "Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„";
      loginSection.classList.remove("hidden");
      registerSection.classList.add("hidden");
      userSection.classList.add("hidden");
      memoriesSection.classList.add("hidden");
      searchSection.classList.add("hidden");
      memoriesList.innerHTML = "";
    }
  });

  // --- ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ---
  openCameraBtn.onclick = async () => {
    cameraContainer.classList.remove("hidden");
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    } catch (e) {
      alert("ØªØ¹Ø°Ø± ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: " + e.message);
    }
  };

  captureBtn.onclick = () => {
    if (!stream) return alert("Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…ÙØ¹Ù„Ø©");
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    capturedPhoto = canvas.toDataURL("image/png");
    capturedImage.src = capturedPhoto;
    capturedImage.classList.remove("hidden");
    stopCamera();
    cameraContainer.classList.add("hidden");
  };

  closeCameraBtn.onclick = () => {
    stopCamera();
    cameraContainer.classList.add("hidden");
  };

  function stopCamera() {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      stream = null;
    }
  }

  // --- Ù†Ø´Ø± Ø°ÙƒØ±Ù‰ Ø¬Ø¯ÙŠØ¯Ø© ---
  postMemoryBtn.onclick = () => {
    memoryMsg.textContent = "";
    const text = memoryText.value.trim();
    const status = memoryStatus.value;
    const user = auth.currentUser;

    if (!user) {
      memoryMsg.textContent = "ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù†Ø´Ø± Ø°ÙƒØ±Ù‰.";
      return;
    }
    if (!text) {
      memoryMsg.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ù†Øµ Ø§Ù„Ø°ÙƒØ±Ù‰.";
      return;
    }

    postMemoryBtn.disabled = true;

    db.collection("memories").add({
      uid: user.uid,
      email: user.email,
      text,
      status,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      likes: [],
      comments: [],
      image: capturedPhoto || null
    }).then(() => {
      memoryText.value = "";
      capturedPhoto = null;
      capturedImage.src = "";
      capturedImage.classList.add("hidden");
      memoryMsg.textContent = "ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø°ÙƒØ±Ù‰ Ø¨Ù†Ø¬Ø§Ø­!";
      postMemoryBtn.disabled = false;
    }).catch(e => {
      memoryMsg.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ø´Ø±: " + e.message;
      postMemoryBtn.disabled = false;
    });
  };

  // --- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø°ÙƒØ±ÙŠØ§Øª ---
  function loadMemories() {
    memoriesList.innerHTML = "";
    db.collection("memories").orderBy("createdAt", "desc").onSnapshot(snapshot => {
      memoriesList.innerHTML = "";
      snapshot.forEach(doc => {
        renderMemory(doc.id, doc.data());
      });
    });
  }

  // --- Ø¹Ø±Ø¶ Ø°ÙƒØ±Ù‰ ---
  function renderMemory(id, memory) {
    const user = auth.currentUser;
    const liked = memory.likes.includes(user?.uid);

    const div = document.createElement("div");
    div.className = "memory";

    div.innerHTML = `
      <div class="status">${escapeHtml(memory.status)}</div>
      <div class="text">${escapeHtml(memory.text)}</div>
      ${memory.image ? `<img src="${memory.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ø°ÙƒØ±Ù‰">` : ""}
      <div><small>Ù…Ù†: ${escapeHtml(memory.email)}</small></div>
      <div><small>ØªØ§Ø±ÙŠØ®: ${memory.createdAt ? memory.createdAt.toDate().toLocaleString() : "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„..."}</small></div>
      <div class="actions">
        <button class="like-btn ${liked ? 'liked' : ''}">${liked ? "â¤ï¸ Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¹Ø¬Ø§Ø¨" : "ğŸ¤ Ø¥Ø¹Ø¬Ø§Ø¨"} (${memory.likes.length})</button>
        <button class="comment-btn">ğŸ’¬ ØªØ¹Ù„ÙŠÙ‚ (${memory.comments.length})</button>
      </div>
      <div class="comments-list" style="margin-top:10px;"></div>
    `;

    const likeBtn = div.querySelector(".like-btn");
    const commentBtn = div.querySelector(".comment-btn");
    const commentsList = div.querySelector(".comments-list");

    // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    commentsList.innerHTML = "";
    memory.comments.forEach(comment => {
      const c = document.createElement("div");
      c.style.borderTop = "1px solid #eee";
      c.style.padding = "6px 0";
      c.innerHTML = `<b>${escapeHtml(comment.email)}</b>: ${escapeHtml(comment.text)}`;
      commentsList.appendChild(c);
    });

    // Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
    likeBtn.onclick = () => {
      if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨.");
      const userLiked = memory.likes.includes(user.uid);
      const updatedLikes = userLiked
        ? memory.likes.filter(uid => uid !== user.uid)
        : [...memory.likes, user.uid];

      db.collection("memories").doc(id).update({ likes: updatedLikes });
    };

    // Ø²Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
    commentBtn.onclick = () => {
      if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ¹Ù„ÙŠÙ‚.");
      const commentText = prompt("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ:");
      if (commentText && commentText.trim()) {
        const newComment = {
          email: user.email,
          text: commentText.trim(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection("memories").doc(id).update({
          comments: firebase.firestore.FieldValue.arrayUnion(newComment)
        });
      }
    };

    memoriesList.appendChild(div);
  }

  // --- Ù‡Ø±ÙˆØ¨ Ø§Ù„Ù†ØµÙˆØµ Ù„Ù…Ù†Ø¹ XSS ---
  function escapeHtml(text) {
    return text
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  // --- Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
  chatIcon.onclick = () => {
    chatSection.classList.toggle("hidden");
    loadChatMessages();
  };
  closeChatBtn.onclick = () => {
    chatSection.classList.add("hidden");
  };

  // --- ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
  let chatUnsub;
  function loadChatMessages() {
    if (chatUnsub) chatUnsub();
    chatMessages.innerHTML = "";
    chatUnsub = db.collection("chat")
      .orderBy("createdAt")
      .limitToLast(50)
      .onSnapshot(snapshot => {
        chatMessages.innerHTML = "";
        snapshot.forEach(doc => {
          const msg = doc.data();
          const div = document.createElement("div");
          div.style.padding = "4px 0";
          div.innerHTML = `<b>${escapeHtml(msg.email)}</b>: ${escapeHtml(msg.text)}`;
          chatMessages.appendChild(div);
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
      });
  }

  // --- Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© ---
  chatSendBtn.onclick = () => {
    const text = chatInput.value.trim();
    const user = auth.currentUser;
    if (!user) {
      alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©.");
      return;
    }
    if (!text) return;

    db.collection("chat").add({
      uid: user.uid,
      email: user.email,
      text,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    chatInput.value = "";
  };

  // --- Ø²Ø± Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ---
  liveIcon.onclick = () => {
    alert("Ø§Ù„Ø®Ø§ØµÙŠØ© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.");
  };

  // --- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ---
  searchIcon.onclick = () => {
    if (searchSection.classList.contains("hidden")) {
      searchSection.classList.remove("hidden");
      memoriesSection.classList.add("hidden");
      userSection.classList.add("hidden");
      loadSearchResults("");
    } else {
      searchSection.classList.add("hidden");
      memoriesSection.classList.remove("hidden");
      userSection.classList.remove("hidden");
    }
  };

  searchInput.oninput = () => {
    const query = searchInput.value.trim().toLowerCase();
    loadSearchResults(query);
  };

  function loadSearchResults(query) {
    searchResults.innerHTML = "Ø¬Ø§Ø±Ù Ø§Ù„Ø¨Ø­Ø«...";
    db.collection("users")
      .get()
      .then(snapshot => {
        let users = [];
        snapshot.forEach(doc => {
          users.push(doc.data());
        });
        // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬)
        if (query) {
          users = users.filter(u => (u.email || "").toLowerCase().includes(query));
        }
        if (users.length === 0) {
          searchResults.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.";
          return;
        }
        searchResults.innerHTML = "";
        users.forEach(u => {
          const div = document.createElement("div");
          div.textContent = u.email;
          searchResults.appendChild(div);
        });
      }).catch(e => {
        searchResults.innerHTML = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«.";
      });
  }

  // --- ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ---
  auth.onAuthStateChanged(user => {
    if (user) {
      // ØªØ£ÙƒØ¯ Ø£Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© users
      db.collection("users").doc(user.uid).set({
        email: user.email,
        uid: user.uid
      }, { merge: true });
    }
  });

</script>

</body>
</html>
